<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Johnny Algae Sea - Carbon Sequestration Calculator</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 900px; 
            margin: auto; 
            padding: 2rem; 
            background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }
        .character-image {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            display: block;
            background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
        }
        h1 {
            color: #2E8B57;
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .subtitle {
            color: #4682B4;
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            font-style: italic;
        }
        .slogan {
            background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(32, 178, 170, 0.3);
        }
        .input-group {
            display: grid !important;
            grid-template-columns: 1fr 1fr 1fr 1fr !important;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .section .input-group {
            display: grid !important;
            grid-template-columns: 1fr 1fr 1fr 1fr !important;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        /* Force 4-column layout for all input groups */
        div.input-group {
            display: grid !important;
            grid-template-columns: 1fr 1fr 1fr 1fr !important;
            grid-template-rows: auto !important;
            gap: 1rem !important;
        }
        /* Override any responsive breakpoints */
        @media (max-width: 1200px) {
            .input-group {
                grid-template-columns: 1fr 1fr 1fr 1fr !important;
            }
        }
        @media (max-width: 768px) {
            .input-group {
                grid-template-columns: 1fr 1fr 1fr 1fr !important;
            }
        }
        .input-container {
            position: relative;
        }
        .info-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: #20B2AA;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            z-index: 10;
        }
        /* Special styling for info icons in results section */
        .result-label .info-icon {
            position: relative;
            display: inline-flex;
            margin-left: 8px;
            right: auto;
            top: auto;
            transform: none;
        }
        .tooltip {
            position: fixed;
            background: #2E8B57;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            width: 250px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            pointer-events: none;
            border: 2px solid #20B2AA;
            max-width: 300px;
        }
        .tooltip.show {
            opacity: 1;
            visibility: visible;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: -5px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid #2E8B57;
        }
        label { 
            display: block; 
            margin: 0.5rem 0; 
            font-weight: 600;
            color: #2E8B57;
        }
        input { 
            width: 100%; 
            padding: 0.8rem;
            border: 2px solid #E0F6FF;
            border-radius: 8px;
            font-size: 1rem;
            background: #F8FFFE;
            transition: all 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #20B2AA;
            background: white;
            box-shadow: 0 0 10px rgba(32, 178, 170, 0.3);
        }
        button { 
            margin: 1.5rem 0; 
            padding: 1.2rem 2.5rem;
            background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(32, 178, 170, 0.3);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(32, 178, 170, 0.4);
        }
        #results { 
            margin-top: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, #E0F6FF 0%, #F0F8FF 100%);
            border-radius: 15px;
            border-left: 6px solid #20B2AA;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            margin: 0.3rem 0;
            padding: 0.3rem 0;
            border-bottom: 1px solid #E0F6FF;
            font-size: 0.95rem;
        }
        .result-label {
            font-weight: 600;
            color: #2E8B57;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .result-value {
            font-weight: 700;
            color: #20B2AA;
        }
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .results-section {
            background: white;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid #E0F6FF;
        }
        .results-section h4 {
            color: #2E8B57;
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }
        .compact-result-item {
            display: flex;
            justify-content: space-between;
            margin: 0.2rem 0;
            padding: 0.2rem 0;
            font-size: 0.9rem;
        }
        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #F0F8FF 0%, #E0F6FF 100%);
            border-radius: 12px;
            border: 2px solid #E0F6FF;
        }
        .section h3 {
            color: #2E8B57;
            margin-top: 0;
            font-size: 1.3rem;
            border-bottom: 2px solid #20B2AA;
            padding-bottom: 0.5rem;
        }
        .viability-indicator {
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-top: 1.5rem;
            font-size: 1.1rem;
        }
        .high { background: linear-gradient(135deg, #90EE90 0%, #98FB98 100%); color: #006400; }
        .medium { background: linear-gradient(135deg, #F0E68C 0%, #FFFFE0 100%); color: #8B4513; }
        .low { background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); color: #8B0000; }
        .ocean-decoration {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #4682B4 0%, #20B2AA 100%);
            border-radius: 0 0 20px 20px;
            opacity: 0.1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="ocean-decoration"></div>
        
        <div class="header">
            <div class="character-image">🌊</div>
            <h1>🌊 Johnny Algae Sea</h1>
            <div class="subtitle">Carbon Sequestration Calculator</div>
            <div class="slogan">Spray. Grow. Sink Carbon.</div>
        </div>
        
        <div class="section">
            <h3>🌱 Biological Parameters</h3>
            <div class="input-group" style="display: grid !important; grid-template-columns: 1fr 1fr 1fr 1fr !important; gap: 1rem;">
                <div class="input-container">
                    <label>NPP (g C/m²/yr): <input id="npp" type="number" value="125" step="1"></label>
                    <div class="info-icon" title="Net Primary Productivity">i</div>
                    <div class="tooltip">Net Primary Productivity measures how much carbon the algae can capture from the atmosphere through photosynthesis. Think of it as the algae's "carbon appetite" - how much CO₂ they can eat and convert to biomass per square meter per year.</div>
                </div>
                <div class="input-container">
                    <label>Export fraction (%): <input id="exportFraction" type="number" value="40" step="1"></label>
                    <div class="info-icon" title="Export Fraction">i</div>
                    <div class="tooltip">Export fraction is the percentage of algae that actually sink to the deep ocean instead of being eaten or decomposed near the surface. Only the sinking algae permanently remove carbon from the atmosphere.</div>
                </div>
                <div class="input-container">
                    <label>Biomass C content (%): <input id="cContent" type="number" value="50" step="0.5"></label>
                    <div class="info-icon" title="Carbon Content">i</div>
                    <div class="tooltip">This is the percentage of the algae's dry weight that is pure carbon. Higher carbon content means more carbon is stored per kilogram of algae biomass.</div>
                </div>
                <div class="input-container">
                    <label>Doubling time (hours): <input id="doublingTime" type="number" value="24" step="1"></label>
                    <div class="info-icon" title="Doubling Time">i</div>
                    <div class="tooltip">How long it takes for the algae population to double in size. Faster doubling (fewer hours) means the algae grow and multiply more quickly, capturing more carbon.</div>
                </div>
            </div>

            <h3>🌊 Environmental Parameters</h3>
            <div class="input-group" style="display: grid !important; grid-template-columns: 1fr 1fr 1fr 1fr !important; gap: 1rem;">
                <div class="input-container">
                    <label>Area (km²): <input id="area" type="number" value="1000" step="100"></label>
                    <div class="info-icon" title="Area">i</div>
                    <div class="tooltip">The total ocean area where the algae will be deployed. Larger areas can sequester more carbon but require more resources to manage.</div>
                </div>
                <div class="input-container">
                    <label>Euphotic depth (m): <input id="euphoticDepth" type="number" value="80" step="5"></label>
                    <div class="info-icon" title="Euphotic Depth">i</div>
                    <div class="tooltip">The depth of water where sunlight can penetrate for photosynthesis. Deeper euphotic zones mean more space for algae to grow and more light available.</div>
                </div>
                <div class="input-container">
                    <label>Surface temperature (°C): <input id="temperature" type="number" value="25" step="0.5"></label>
                    <div class="info-icon" title="Temperature">i</div>
                    <div class="tooltip">The water temperature at the ocean surface. Algae have optimal temperature ranges - too hot or too cold and they won't grow well.</div>
                </div>
                <div class="input-container">
                    <label>Salinity (ppt): <input id="salinity" type="number" value="35" step="0.5"></label>
                    <div class="info-icon" title="Salinity">i</div>
                    <div class="tooltip">The saltiness of the ocean water (parts per thousand). Different algae strains prefer different salinity levels for optimal growth.</div>
                </div>
            </div>

            <h3>💰 Economic Parameters</h3>
            <div class="input-group" style="display: grid !important; grid-template-columns: 1fr 1fr 1fr 1fr !important; gap: 1rem;">
                <div class="input-container">
                    <label>Cost per kg biomass ($): <input id="costBiomass" type="number" value="0.5" step="0.1"></label>
                    <div class="info-icon" title="Biomass Cost">i</div>
                    <div class="tooltip">How much it costs to grow and prepare one kilogram of algae biomass for deployment. This includes cultivation, processing, and preparation costs.</div>
                </div>
                <div class="input-container">
                    <label>Delivery cost per kg ($): <input id="deliveryCost" type="number" value="0.3" step="0.1"></label>
                    <div class="info-icon" title="Delivery Cost">i</div>
                    <div class="tooltip">The cost to transport and deploy one kilogram of algae to the target ocean area. Includes fuel, vessel time, and deployment equipment.</div>
                </div>
                <div class="input-container">
                    <label>Vessel cost per day ($): <input id="vesselCost" type="number" value="5000" step="500"></label>
                    <div class="info-icon" title="Vessel Cost">i</div>
                    <div class="tooltip">The daily operating cost of the ships needed to deploy and monitor the algae. Includes crew, fuel, maintenance, and vessel rental.</div>
                </div>
                <div class="input-container">
                    <label>Monitoring cost ($/yr): <input id="monitoringCost" type="number" value="100000" step="10000"></label>
                    <div class="info-icon" title="Monitoring Cost">i</div>
                    <div class="tooltip">Annual costs for monitoring the algae deployment, including scientific measurements, environmental impact assessment, and compliance reporting.</div>
                </div>
            </div>

            <h3>🌍 Targets</h3>
            <div class="input-group" style="display: grid !important; grid-template-columns: 1fr 1fr 1fr 1fr !important; gap: 1rem;">
                <div class="input-container">
                    <label>Target Cost ($/t): <input id="targetCostPerTonne" type="number" value="100" step="10"></label>
                    <div class="info-icon" title="Target Cost">i</div>
                    <div class="tooltip">The target cost per tonne of CO₂ removed. IPCC benchmark is $50-200/t, with $100/t being competitive for most CDR projects.</div>
                </div>
                <div class="input-container">
                    <label>Target Scale (Mt CO₂/yr): <input id="targetScale" type="number" value="1.0" step="0.1"></label>
                    <div class="info-icon" title="Target Scale">i</div>
                    <div class="tooltip">The target annual CO₂ removal scale in millions of tonnes. Commercial projects typically aim for >1 Mt CO₂/yr.</div>
                </div>
                <div class="input-container">
                    <label>Min Permanence (years): <input id="minPermanence" type="number" value="100" step="10"></label>
                    <div class="info-icon" title="Min Permanence">i</div>
                    <div class="tooltip">Minimum storage time required for carbon sequestration to be considered permanent. Ocean sequestration should exceed 100 years.</div>
                </div>
                <div class="input-container">
                    <label>Max Leakage Risk (%): <input id="maxLeakageRisk" type="number" value="5" step="1"></label>
                    <div class="info-icon" title="Max Leakage Risk">i</div>
                    <div class="tooltip">Maximum acceptable percentage of stored CO₂ that could re-enter the atmosphere. Should be kept below 5% for effective sequestration.</div>
                </div>
            </div>
            <div class="input-group" style="display: grid !important; grid-template-columns: 1fr 1fr 1fr 1fr !important; gap: 1rem;">
                <div class="input-container">
                    <label>Cost Weight (%): <input id="costWeight" type="number" value="50" step="5"></label>
                    <div class="info-icon" title="Cost Weight">i</div>
                    <div class="tooltip">How much weight to give cost competitiveness in the overall viability assessment. Higher values prioritize cost over other factors.</div>
                </div>
                <div class="input-container">
                    <label>Scale Weight (%): <input id="scaleWeight" type="number" value="30" step="5"></label>
                    <div class="info-icon" title="Scale Weight">i</div>
                    <div class="tooltip">How much weight to give scale achievement in the overall viability assessment. Higher values prioritize large-scale deployment.</div>
                </div>
                <div class="input-container">
                    <label>Env. Weight (%): <input id="environmentalWeight" type="number" value="20" step="5"></label>
                    <div class="info-icon" title="Environmental Weight">i</div>
                    <div class="tooltip">How much weight to give environmental factors (permanence, leakage) in the overall viability assessment. Higher values prioritize environmental safety.</div>
                </div>
                <div class="input-container">
                    <label>Est. Permanence (yr): <input id="estimatedPermanence" type="number" value="500" step="50"></label>
                    <div class="info-icon" title="Estimated Permanence">i</div>
                    <div class="tooltip">Estimated storage time for carbon sequestered at the specified depth. Deeper sequestration generally means longer permanence.</div>
                </div>
            </div>
        </div>

        <div id="results" style="display: none;">
            <h2>📊 Results</h2>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // Tooltip functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all input fields for automatic recalculation
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    calculate();
                });
            });
            
            // Initial calculation
            calculate();
            
            // Set up tooltips for results section after calculation
            setupTooltips();
        });

        function setupTooltips() {
            const infoIcons = document.querySelectorAll('.info-icon');
            
            infoIcons.forEach((icon, index) => {
                const tooltip = icon.nextElementSibling;
                
                if (!tooltip) {
                    return;
                }
                
                // Ensure tooltip has the correct CSS class
                tooltip.className = 'tooltip';
                
                // Remove any existing listeners
                icon.removeEventListener('mouseenter', icon._mouseenterHandler);
                icon.removeEventListener('mouseleave', icon._mouseleaveHandler);
                
                // Create new handlers
                icon._mouseenterHandler = function(e) {
                    e.stopPropagation();
                    
                    // Hide all tooltips first
                    document.querySelectorAll('.tooltip').forEach(t => {
                        t.classList.remove('show');
                    });
                    
                    // Show this tooltip using the CSS class approach
                    tooltip.classList.add('show');
                    
                    // Position tooltip near mouse cursor
                    const mouseX = e.clientX;
                    const mouseY = e.clientY;
                    
                    // Position tooltip to the right of the cursor, but ensure it stays within viewport
                    let left = mouseX + 15;
                    let top = mouseY - 10;
                    
                    // Check if tooltip would go off the right edge
                    if (left + 250 > window.innerWidth) {
                        left = mouseX - 265; // Position to the left of cursor
                    }
                    
                    // Check if tooltip would go off the bottom edge
                    if (top + tooltip.offsetHeight > window.innerHeight) {
                        top = mouseY - tooltip.offsetHeight - 10;
                    }
                    
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                };
                
                icon._mouseleaveHandler = function(e) {
                    tooltip.classList.remove('show');
                };
                
                // Add listeners
                icon.addEventListener('mouseenter', icon._mouseenterHandler);
                icon.addEventListener('mouseleave', icon._mouseleaveHandler);
            });
        }

        function calculate() {
            
            // Get inputs
            const npp = parseFloat(document.getElementById('npp').value); // g C/m2/yr
            const exportFrac = parseFloat(document.getElementById('exportFraction').value) / 100;
            const area_m2 = parseFloat(document.getElementById('area').value) * 1e6; // km2 -> m2
            const cContent = parseFloat(document.getElementById('cContent').value) / 100;
            const doublingTime = parseFloat(document.getElementById('doublingTime').value);
            const euphoticDepth = parseFloat(document.getElementById('euphoticDepth').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const salinity = parseFloat(document.getElementById('salinity').value);
            const costBiomass = parseFloat(document.getElementById('costBiomass').value); // $/kg
            const deliveryCost = parseFloat(document.getElementById('deliveryCost').value); // $/kg
            const vesselCost = parseFloat(document.getElementById('vesselCost').value); // $/day
            const monitoringCost = parseFloat(document.getElementById('monitoringCost').value); // $/year
            const targetCostPerTonne = parseFloat(document.getElementById('targetCostPerTonne').value); // $/t
            const targetScale = parseFloat(document.getElementById('targetScale').value) * 1e6; // Mt CO2/yr -> kg CO2/yr
            const minPermanence = parseFloat(document.getElementById('minPermanence').value); // years
            const maxLeakageRisk = parseFloat(document.getElementById('maxLeakageRisk').value) / 100; // %
            const costWeight = parseFloat(document.getElementById('costWeight').value) / 100; // %
            const scaleWeight = parseFloat(document.getElementById('scaleWeight').value) / 100; // %
            const environmentalWeight = parseFloat(document.getElementById('environmentalWeight').value) / 100; // %
            const estimatedPermanence = parseFloat(document.getElementById('estimatedPermanence').value); // years

            // Calculate growth rate based on doubling time
            const growthRate = Math.log(2) / (doublingTime / 24); // per day

            // Environmental factors (simplified)
            const tempFactor = temperature >= 20 && temperature <= 30 ? 1.0 : 0.5;
            const lightFactor = euphoticDepth >= 100 ? 1.0 : euphoticDepth / 100; // More realistic scaling
            const salinityFactor = salinity >= 30 && salinity <= 40 ? 1.0 : 0.7;
            
            const environmentalFactor = tempFactor * lightFactor * salinityFactor;

            // Calculate carbon sequestration
            const effectiveNPP = npp * environmentalFactor;
            const carbonExport = effectiveNPP * exportFrac; // g C/m2/yr
            const carbonExportTotal = carbonExport * area_m2 / 1000; // kg C/yr
            const co2Removed = carbonExportTotal * 3.67 / 1000; // tonnes CO2/yr

            // Calculate biomass required for the carbon sequestration
            // We need enough biomass to produce the carbon that gets exported
            const biomassNeeded = carbonExportTotal / cContent; // kg/yr (carbon export / carbon content)

            // Calculate costs
            const cultivationCost = biomassNeeded * costBiomass;
            const deliveryCostTotal = biomassNeeded * deliveryCost;
            const vesselCostTotal = vesselCost * 365;
            const totalCost = cultivationCost + deliveryCostTotal + vesselCostTotal + monitoringCost;
            const costPerTonne = co2Removed > 0 ? totalCost / co2Removed : Infinity;

            // Calculate viability metrics
            const viabilityScore = calculateViabilityScore(costPerTonne, co2Removed, targetCostPerTonne, targetScale, minPermanence, maxLeakageRisk, costWeight, scaleWeight, environmentalWeight, estimatedPermanence);
            
            // Calculate individual component scores for display
            const costScore = costPerTonne <= targetCostPerTonne * 0.5 ? 1.0 : 
                             costPerTonne <= targetCostPerTonne ? 0.8 : 
                             costPerTonne <= targetCostPerTonne * 1.5 ? 0.4 : 
                             costPerTonne <= targetCostPerTonne * 3 ? 0.1 : 0.0;
            const scaleScore = Math.min(1, co2Removed / targetScale);
            const permanenceScore = Math.min(1, estimatedPermanence / minPermanence);
            const leakageRiskScore = 1 - maxLeakageRisk;
            const environmentalScore = (permanenceScore + leakageRiskScore) / 2;
            
            const costCompetitiveness = targetCostPerTonne / costPerTonne; // Target ratio
            const scaleAdequacy = co2Removed / targetScale; // Target ratio - targetScale is already in tonnes/yr
            const permanenceAdequacy = estimatedPermanence / minPermanence; // Target ratio
            const leakageRisk = (1 - exportFrac) * 100; // % of carbon that doesn't sink

            // Store results globally for export
            window.currentResults = {
                carbonExportTotal,
                co2Removed,
                biomassNeeded,
                totalCost,
                costPerTonne,
                viabilityScore,
                costCompetitiveness,
                scaleAdequacy,
                permanenceAdequacy,
                leakageRisk,
                environmentalFactor,
                effectiveNPP,
                growthRate: growthRate * environmentalFactor,
                parameters: {
                    npp, exportFrac, area_m2, cContent, doublingTime, euphoticDepth,
                    temperature, salinity, costBiomass, deliveryCost, vesselCost, monitoringCost,
                    targetCostPerTonne, targetScale, minPermanence, maxLeakageRisk, costWeight, scaleWeight, environmentalWeight, estimatedPermanence
                }
            };

            // Display results
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="results-grid">
                    <div class="results-section">
                        <h4>🌱 Carbon Sequestration</h4>
                        <div class="compact-result-item">
                            <span class="result-label">
                                CO₂ Removed (tonnes/yr)
                                <div class="info-icon" title="CO₂ Removed">i</div>
                                <div class="tooltip">Calculated as: (NPP × Environmental Factor × Export Fraction × Area) × 3.67. This converts carbon to CO₂ and shows total annual carbon dioxide removal from the atmosphere.</div>
                            </span>
                            <span class="result-value">${co2Removed.toLocaleString()}</span>
                        </div>
                        <div class="compact-result-item">
                            <span class="result-label">
                                Cost per Tonne CO₂ ($/t)
                                <div class="info-icon" title="Cost per Tonne CO₂">i</div>
                                <div class="tooltip">Calculated as: (Cultivation Cost + Delivery Cost + Vessel Cost + Monitoring Cost) ÷ CO₂ Removed. This is the key economic metric - competitive CDR typically costs $50-200 per tonne.</div>
                            </span>
                            <span class="result-value">$${costPerTonne.toFixed(2)}</span>
                        </div>
                        <div class="compact-result-item">
                            <span class="result-label">
                                Cost vs Target
                                <div class="info-icon" title="Cost vs Target">i</div>
                                <div class="tooltip">Calculated as: Target Cost ÷ Actual Cost. Values >1.0 mean the solution is cheaper than your target, <1.0 means it's more expensive. Your target is $${targetCostPerTonne}/t.</div>
                            </span>
                            <span class="result-value">${costCompetitiveness.toFixed(2)}x target</span>
                        </div>
                    </div>
                    
                    <div class="results-section">
                        <h4>🎯 Assessment</h4>
                        <div class="compact-result-item">
                            <span class="result-label">
                                Viability Score
                                <div class="info-icon" title="Viability Score">i</div>
                                <div class="tooltip">Calculated as: (Cost Score × ${(costWeight*100).toFixed(0)}%) + (Scale Score × ${(scaleWeight*100).toFixed(0)}%) + (Environmental Score × ${(environmentalWeight*100).toFixed(0)}%). Cost Score: ${costScore.toFixed(2)}, Scale Score: ${scaleScore.toFixed(2)}, Environmental Score: ${environmentalScore.toFixed(2)}. Change the weights to see how they affect the overall score.</div>
                            </span>
                            <span class="result-value">${viabilityScore.toFixed(2)}/1.00</span>
                        </div>
                        <div class="compact-result-item">
                            <span class="result-label">
                                Scale vs Target
                                <div class="info-icon" title="Scale vs Target">i</div>
                                <div class="tooltip">Calculated as: Actual CO₂ Removed ÷ Target Scale. Shows how significant this deployment is compared to your target of ${(targetScale/1e6).toFixed(1)} Mt CO₂/yr. Values >1.0 mean you're exceeding your scale target.</div>
                            </span>
                            <span class="result-value">${scaleAdequacy.toFixed(2)}x target</span>
                        </div>
                        <div class="compact-result-item">
                            <span class="result-label">
                                Environmental Factor
                                <div class="info-icon" title="Environmental Factor">i</div>
                                <div class="tooltip">Calculated as: Temperature Factor × Light Factor × Salinity Factor. Temperature: optimal 20-30°C. Light: based on euphotic depth. Salinity: optimal 30-40 ppt. Perfect conditions = 1.0, poor conditions reduce this value.</div>
                            </span>
                            <span class="result-value">${environmentalFactor.toFixed(2)}</span>
                        </div>
                        <div class="compact-result-item">
                            <span class="result-label">
                                Permanence vs Target
                                <div class="info-icon" title="Permanence vs Target">i</div>
                                <div class="tooltip">Calculated as: Estimated Permanence ÷ Min Permanence. Shows how the estimated storage time compares to your minimum requirement. Values >1.0 mean longer storage than required.</div>
                            </span>
                            <span class="result-value">${permanenceAdequacy.toFixed(2)}x target</span>
                        </div>
                        <div class="compact-result-item">
                            <span class="result-label">
                                Leakage Risk (%)
                                <div class="info-icon" title="Leakage Risk">i</div>
                                <div class="tooltip">Calculated as: (1 - Export Fraction) × 100. Shows percentage of carbon that doesn't sink to sequestration depth. Should be below your Max Leakage Risk target.</div>
                            </span>
                            <span class="result-value">${leakageRisk.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="viability-indicator ${getViabilityClass(viabilityScore)}">
                    ${getViabilityMessage(viabilityScore)}
                </div>
            `;

            document.getElementById('results').style.display = 'block';
            
            // Set up tooltips for the results section with a small delay to ensure DOM is ready
            setTimeout(() => {
                setupTooltips();
            }, 100);
            
        }

        // Make calculate function globally accessible
        window.calculate = calculate;

        function calculateViabilityScore(costPerTonne, co2Removed, targetCostPerTonne, targetScale, minPermanence, maxLeakageRisk, costWeight, scaleWeight, environmentalWeight, estimatedPermanence) {
            if (costPerTonne <= 0 || co2Removed <= 0) return 0;
            
            console.log('=== VIABILITY SCORE DEBUG ===');
            console.log('Input parameters:');
            console.log('  costPerTonne:', costPerTonne);
            console.log('  co2Removed:', co2Removed);
            console.log('  targetCostPerTonne:', targetCostPerTonne);
            console.log('  targetScale:', targetScale);
            console.log('  minPermanence:', minPermanence);
            console.log('  maxLeakageRisk:', maxLeakageRisk);
            console.log('  costWeight:', costWeight);
            console.log('  scaleWeight:', scaleWeight);
            console.log('  environmentalWeight:', environmentalWeight);
            console.log('  estimatedPermanence:', estimatedPermanence);
            
            // Cost component (lower is better) - Fixed calculation
            let costScore;
            if (costPerTonne <= targetCostPerTonne * 0.5) { // 50% of target
                costScore = 1.0; // Perfect score for very low cost
            } else if (costPerTonne <= targetCostPerTonne) { // Up to target
                costScore = 0.8; // Good score for competitive cost
            } else if (costPerTonne <= targetCostPerTonne * 1.5) { // 50% above target
                costScore = 0.4; // Medium score for expensive cost
            } else if (costPerTonne <= targetCostPerTonne * 3) { // 100% above target
                costScore = 0.1; // Poor score for very expensive cost
            } else {
                costScore = 0.0; // Zero score for extremely expensive cost
            }
            
            // Scale component (higher is better)
            const scaleScore = Math.min(1, co2Removed / targetScale); // 100% of target as full score
            
            // Environmental safety component (assuming genetic kill switch)
            const permanenceScore = Math.min(1, estimatedPermanence / minPermanence); // 100% of min as full score
            const leakageRiskScore = 1 - maxLeakageRisk; // 100% safe as full score
            
            console.log('Individual scores:');
            console.log('  costScore:', costScore);
            console.log('  scaleScore:', scaleScore);
            console.log('  permanenceScore:', permanenceScore);
            console.log('  leakageRiskScore:', leakageRiskScore);
            
            // Calculate base score - FIXED: Environmental weight was being applied twice
            const environmentalScore = (permanenceScore + leakageRiskScore) / 2;
            let baseScore = (costScore * costWeight) + (scaleScore * scaleWeight) + (environmentalScore * environmentalWeight);
            
            console.log('Weighted components:');
            console.log('  costScore * costWeight:', costScore * costWeight);
            console.log('  scaleScore * scaleWeight:', scaleScore * scaleWeight);
            console.log('  environmentalScore * environmentalWeight:', environmentalScore * environmentalWeight);
            console.log('  environmentalScore (avg):', environmentalScore);
            console.log('  OLD CALCULATION would have been:', (permanenceScore * environmentalWeight) + (leakageRiskScore * environmentalWeight));
            
            // Apply cost penalty for extremely expensive projects
            if (costPerTonne > targetCostPerTonne * 3) { // 300% of target
                baseScore *= 0.5; // Halve the score for extremely expensive projects
                console.log('Applied cost penalty - halved score');
            }
            
            console.log('Final baseScore:', baseScore);
            console.log('=== END DEBUG ===');
            
            return baseScore;
        }

        function getViabilityClass(score) {
            if (score > 0.7) return 'high';
            if (score > 0.4) return 'medium';
            return 'low';
        }

        function getViabilityMessage(score) {
            if (score > 0.7) return '✅ HIGH VIABILITY - Johnny Algae Sea shows strong potential for carbon sequestration!';
            if (score > 0.4) return '⚠️ MEDIUM VIABILITY - Johnny Algae Sea may be viable with optimization';
            return '❌ LOW VIABILITY - Johnny Algae Sea needs significant improvements to be viable';
        }

        function exportToCSV() {
            if (!window.currentResults) return;
            
            const results = window.currentResults;
            const csvContent = [
                'Metric,Value,Unit',
                `Carbon Export,${results.carbonExportTotal.toLocaleString()},kg C/yr`,
                `CO₂ Removed,${results.co2Removed.toLocaleString()},tonnes/yr`,
                `Biomass Required,${results.biomassNeeded.toLocaleString()},kg/yr`,
                `Total Cost,$${results.totalCost.toLocaleString()},$/yr`,
                `Cost per Tonne CO₂,$${results.costPerTonne.toFixed(2)},$/t`,
                `Cost vs Target,${results.costCompetitiveness.toFixed(2)},x target`,
                `Scale vs Target,${results.scaleAdequacy.toFixed(2)},x target`,
                `Permanence vs Target,${results.permanenceAdequacy.toFixed(2)},x target`,
                `Leakage Risk,${results.leakageRisk.toFixed(1)},%`,
                `Viability Score,${results.viabilityScore.toFixed(2)},/1.00`,
                `Environmental Factor,${results.environmentalFactor.toFixed(2)},`,
                `Effective NPP,${results.effectiveNPP.toFixed(1)},g C/m²/yr`,
                `Growth Rate,${results.growthRate.toFixed(3)},per day`,
                `Target Cost per Tonne,$${results.parameters.targetCostPerTonne},$/t`,
                `Target Scale,${results.parameters.targetScale / 1e6},Mt CO₂/yr`,
                `Min Permanence,${results.parameters.minPermanence},years`,
                `Max Leakage Risk,${results.parameters.maxLeakageRisk * 100},%`,
                `Cost Weight,${results.parameters.costWeight * 100},%`,
                `Scale Weight,${results.parameters.scaleWeight * 100},%`,
                `Environmental Weight,${results.parameters.environmentalWeight * 100},%`
            ].join('\n');
            
            downloadFile(csvContent, 'johnny_algae_sea_results.csv', 'text/csv');
        }

        function exportToJSON() {
            if (!window.currentResults) return;
            
            const jsonContent = JSON.stringify(window.currentResults, null, 2);
            downloadFile(jsonContent, 'johnny_algae_sea_results.json', 'application/json');
        }

        function printResults() {
            window.print();
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 